# version: "3.8"
services:
  wireguard:        # WIREGUARD
    image: linuxserver/wireguard:latest
    container_name: wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Bogota
    volumes:
      - ./wireguard-config:/config
      - /lib/modules:/lib/modules:ro
    ports:
      - 51820:51820/udp   
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    restart: unless-stopped
    privileged: true
    networks:
      - vpn_net    
      - default   

  payment-webhook:   # WEBHOOK DE PAGOS
    build: ./payment-webhook
    container_name: payment-webhook-api
    ports:
      - 3000:3000  # Expuesto p√∫blicamente    
    depends_on:
      postgres-db:
        condition: service_healthy
      wireguard:
        condition: service_started        
    volumes:
      - ./payment-webhook:/app      
      - /app/node_modules 
      - shared-logs:/app/logs
    environment:
      - DATABASE_URL=postgres://postgres:postgres@postgres-db:5432/widelink
      - DB_HOST=postgres-db
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_NAME=widelink   
      - POSTGRES_PASSWORD=postgres  
      - OLT_ENCRYPTION_KEY=81da36a013cfa37306c18c61f05d208a6a3247e52c6572908840ba3a3d72de97
    restart: unless-stopped
    networks:
      - default    
    
  payment-worker:   # WORKER CON VPN 
    build: ./payment-worker
    container_name: payment-worker
    cap_add:
      - NET_ADMIN    
    depends_on:
      postgres-db:
        condition: service_healthy
      wireguard:
        condition: service_started
    volumes:
      - ./payment-worker:/app
      - /app/node_modules
      - shared-logs:/app/logs
    environment:
      - DATABASE_URL=postgres://postgres:postgres@172.20.0.1:54325/widelink
      - DB_HOST=172.20.0.1
      - DB_PORT=54325
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_NAME=widelink      
      - POSTGRES_PASSWORD=postgres    
      - OLT_ENCRYPTION_KEY=81da36a013cfa37306c18c61f05d208a6a3247e52c6572908840ba3a3d72de97      
    restart: unless-stopped    
    network_mode: "service:wireguard"

  postgres-db:  # POSTGRES CON PGMQ 
    image: public.ecr.aws/supabase/postgres:17.4.1.074 
    container_name: postgres-db
    command: postgres -c listen_addresses='*'
    restart: unless-stopped
    ports:
      - "54322:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: widelink
      PGDATA: /var/lib/postgresql/data
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -h localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s    
    networks:
      - default      
      - vpn_net
      
networks:
  default:
    name: reconnect-system_default
  vpn_net:
    name: reconnect-system_vpn
    
volumes:  
  shared-logs: {}    